{% extends "../../partials/layout.njk" %}

{% macro getRiskLevelText(level) %}
    {% if level == 'VERY_HIGH' %}
        Very high
    {% elif level == 'HIGH' %}
        High
    {% elif level == 'MEDIUM' %}
        Medium
    {% elif level == 'LOW' %}
        Low
    {% elif level == 'NOT_APPLICABLE' %}
        Not applicable
    {% endif %}
{% endmacro %}

{% macro formatAddress(address) %}
    {% if not address.noFixedAbode %}
     <p class="govuk-body">
        {% if address.line1 %}
            {{ address.line1 }},
        {% endif %}
        {% if address.line2 %}
            {{ address.line2 }},
        {% endif %}
        {% if address.town %}
            {{ address.town }},
        {% endif %}
        {% if address.postcode %}
            {{ address.postcode }}
        {% endif %}
    </p>
    {% endif %}
{% endmacro %}

{% macro blankSafe(value, mandatory, message) %}
    {% if value %}
        {{ value }}
    {% else %}
        {% if mandatory %}
            <svg class="govuk-icon" fill="currentColor" role="presentation" focusable="false" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 25 25" height="25" width="25">
                <path d="M13.7,18.5h-2.4v-2.4h2.4V18.5z M12.5,13.7c-0.7,0-1.2-0.5-1.2-1.2V7.7c0-0.7,0.5-1.2,1.2-1.2s1.2,0.5,1.2,1.2v4.8 C13.7,13.2,13.2,13.7,12.5,13.7z M12.5,0.5c-6.6,0-12,5.4-12,12s5.4,12,12,12s12-5.4,12-12S19.1,0.5,12.5,0.5z"></path>
            </svg>
            {{ message }}
        {% else %}
            - <span class="govuk-visually-hidden">no value</span>
        {% endif %}
    {% endif %}
{% endmacro %}

{% macro editedBadge(display) %}
    {% if display %}
        <strong class="govuk-tag">
            Edited
        </strong>
    {% endif %}
{% endmacro %}

{% set pageTitle = makePageTitle({ pageHeading: pageTitles[page.id], hasErrors: errors }) %}

{% block beforeContent %}
    {{ backLink() }}
{% endblock %}
{% block content %}
    <div class="govuk-grid-row">
        <div class="govuk-grid-column-two-thirds-from-desktop">
        {% include '../../partials/error-summary.njk' %}

            <h1 class='govuk-heading-l'>{{ pageHeadings[page.id] }}</h1>

            <p class="govuk-body">
                These details are from NOMIS and the Part A.  They will go into the PPUD record.  You should:
            </p>

            <ul class='govuk-list govuk-list--number'>
                <li>Double-check everything is correct.</li>
                <li>Edit anything that's wrong.</li>

                {% if warnings|length %}
                    {% set html %}
                        <p class="govuk-body-m govuk-!-margin-bottom-0">
                            These details are different in PPUD.  Edit anything that's wrong.

                            <ul class="govuk-list">
                            {% for key, val in warnings %}
                                  <li>
                                    <span class="govuk-body govuk-!-font-weight-bold">{{ key }}:</span>
                                    <span class="govuk-body">{{ blankSafe(val) }}</span>
                                  </li>
                            {% endfor %}
                            </ul>
                        </p>
                    {% endset %}

                    {{ govukNotificationBanner({
                        titleText: 'Some NOMIS information is different to PPUD',
                        html: html,
                        classes: "govuk-notification-banner--info"
                    }) }}
                {% endif %}

                <li>Continue to the next page and select the index offence.</li>
            </ul>

            {% if errorMessage %}
                {% set html %}
                    <h1 class="govuk-heading-m" data-qa='multiple-results'>NOMIS error</h1>
                    <span> {{errorMessage}}</span>
                {% endset %}

                {{ mojBanner({
                    type: 'warning',
                    html: html,
                    iconFallbackText: 'none'
                }) }}
            {% endif %}

            <form novalidate method="post">
                <input type="hidden" name="_csrf" value="{{ csrfToken }}" />
                <input type="hidden" name="ppudRecordPresent" value="{{ recommendation.ppudRecordPresent }}" />

                <h2 class='govuk-heading-m'>Personal details from NOMIS</h2>

                <dl class="govuk-summary-list govuk-!-margin-bottom-4">
                    <div class="govuk-summary-list__row">
                        <dt class="govuk-summary-list__key">
                        </dt>
                    </div>
                    <div class="govuk-summary-list__row">
                        <dt class="govuk-summary-list__key">
                            Image
                        </dt>
                        <dd class="govuk-summary-list__value">
                            {% if recommendation.prisonOffender.image %}
                            <img src="{{ recommendation.prisonOffender.image }}"/>
                            {% else %}
                            - <span class="govuk-visually-hidden">no value</span>
                            {% endif %}
                        </dd>
                    </div>
                    <div class="govuk-summary-list__row">
                        <dt class="govuk-summary-list__key">
                            NOMIS number
                        </dt>
                        <dd class="govuk-summary-list__value">
                            {{ blankSafe(recommendation.personOnProbation.nomsNumber) }}
                        </dd>
                    </div>
                    <div class="govuk-summary-list__row">
                        <dt class="govuk-summary-list__key">
                            First names
                        </dt>
                        <dd class="govuk-summary-list__value">
                            {{ editedBadge(edited.firstNames) }}
                            {{ blankSafe(recommendation.bookRecallToPpud.firstNames) }}
                        </dd>
                        <dd class="govuk-summary-list__actions">
                            <a class='govuk-link' href='edit-name'>Edit</a>
                        </dd>
                    </div>
                    <div class="govuk-summary-list__row">
                        <dt class="govuk-summary-list__key">
                            Last name
                        </dt>
                        <dd class="govuk-summary-list__value">
                            {{ editedBadge(edited.lastName) }}
                            {{ blankSafe(recommendation.bookRecallToPpud.lastName) }}
                        </dd>
                        <dd class="govuk-summary-list__actions">
                            <a class='govuk-link' href='edit-name'>Edit</a>
                        </dd>
                    </div>
                    <div class="govuk-summary-list__row">
                        <dt class="govuk-summary-list__key">
                            {{ errorDisplay(errors.gender) }}
                            Gender
                        </dt>
                        <dd class="govuk-summary-list__value">
                            {{ blankSafe(recommendation.bookRecallToPpud.gender, true, 'You must enter a gender') }}
                        </dd>
                        <dd class="govuk-summary-list__actions">
                            <a class='govuk-link' href='edit-gender'>Edit</a>
                        </dd>
                    </div>
                    <div class="govuk-summary-list__row">
                        <dt class="govuk-summary-list__key">
                            {{ errorDisplay(errors.ethnicity) }}
                            Ethnicity
                        </dt>
                        <dd class="govuk-summary-list__value">
                            {{ blankSafe(recommendation.bookRecallToPpud.ethnicity, true, 'You must enter a ethnicity') }}
                        </dd>
                        <dd class="govuk-summary-list__actions">
                            <a class='govuk-link' href='edit-ethnicity'>Edit</a>
                        </dd>
                    </div>
                    <div class="govuk-summary-list__row">
                        <dt class="govuk-summary-list__key">
                            Date of birth
                        </dt>
                        <dd class="govuk-summary-list__value">
                            {{ editedBadge(edited.dateOfBirth) }}
                            {{ blankSafe(
                            formatDateTimeFromIsoString({ isoDate: recommendation.bookRecallToPpud.dateOfBirth, dateOnly: true })) }}
                        </dd>
                        <dd class="govuk-summary-list__actions">
                            <a class='govuk-link' href='edit-date-of-birth'>Edit</a>
                        </dd>
                    </div>
                    <div class="govuk-summary-list__row">
                        <dt class="govuk-summary-list__key">
                            CRO
                        </dt>
                        <dd class="govuk-summary-list__value">
                            {{ blankSafe(recommendation.bookRecallToPpud.cro) }}
                        </dd>
                        <dd class="govuk-summary-list__actions">
                            <a class='govuk-link' href='edit-cro'>Edit</a>
                        </dd>
                    </div>
                    <div class="govuk-summary-list__row">
                        <dt class="govuk-summary-list__key">
                            {{ errorDisplay(errors.prisonNumber) }}
                            Prison booking number
                        </dt>
                        <dd class="govuk-summary-list__value">
                            {{ editedBadge(edited.prisonNumber) }}
                            {{ blankSafe(recommendation.bookRecallToPpud.prisonNumber) }}
                        </dd>
                        <dd class="govuk-summary-list__actions">
                            <a class='govuk-link' href='xyz'>Edit</a>
                        </dd>
                    </div>
                    <div class="govuk-summary-list__row">
                        <dt class="govuk-summary-list__key">
                            {{ errorDisplay(errors.releasingPrison) }}
                            Releasing prison
                        </dt>
                        <dd class="govuk-summary-list__value">
                            {{ blankSafe(recommendation.bookRecallToPpud.releasingPrison, true, 'You must enter releasing prison') }}
                        </dd>
                        <dd class="govuk-summary-list__actions">
                            <a class='govuk-link' href='edit-releasing-prison'>Edit</a>
                        </dd>
                    </div>
                    <div class="govuk-summary-list__row">
                        <dt class="govuk-summary-list__key">
                            {{ errorDisplay(errors.legislationReleasedUnder) }}
                            Legislation released under
                        </dt>
                        <dd class="govuk-summary-list__value">
                            {{ blankSafe(recommendation.bookRecallToPpud.legislationReleasedUnder, true, 'You must enter legislation') }}
                        </dd>
                        <dd class="govuk-summary-list__actions">
                            <a class='govuk-link' href='edit-legislation-released-under'>Edit</a>
                        </dd>
                    </div>
                    <div class="govuk-summary-list__row">
                        <dt class="govuk-summary-list__key">
                            Custody status
                        </dt>
                        <dd class="govuk-summary-list__value">
                            {% if recommendation.prisonOffender.status == "ACTIVE IN" %}
                                In custody
                            {% elseif recommendation.prisonOffender.status == "INACTIVE OUT" %}
                                Unlawfully at large (UAL)
                            {% elseif recommendation.prisonOffender.status == "INACTIVE TRN" %}
                                In transit - Unlawfully at large (UAL)
                            {% else %}
                                - <span class="govuk-visually-hidden">no value</span>
                            {% endif %}
                        </dd>
                    </div>
                    <div class="govuk-summary-list__row">
                        <dt class="govuk-summary-list__key">
                            {{ errorDisplay(errors.custodyType) }}
                            Custody type
                        </dt>
                        <dd class="govuk-summary-list__value">
                            {{ blankSafe(recommendation.bookRecallToPpud.custodyType, true, 'You must enter a custody type') }}
                        </dd>
                        <dd class="govuk-summary-list__actions">
                            <a class='govuk-link' href='edit-custody-type'>Edit</a>
                        </dd>
                    </div>
                    <div class="govuk-summary-list__row">
                        <dt class="govuk-summary-list__key">
                            Last known address
                            <p class="govuk-hint">From the Part A</p>
                        </dt>
                        <dd class="govuk-summary-list__value">
                            {% for address in recommendation.personOnProbation.addresses %}
                                {{ formatAddress(address) }}
                            {% endfor %}
                            {% if not recommendation.personOnProbation.addresses %}
                                - <span class="govuk-visually-hidden">no value</span>
                            {% endif %}
                            <p class="govuk-body govuk-!-font-weight-bold">
                                Additional address
                            </p>
                            <span class="govuk-body">
                                {{ blankSafe(recommendation.isMainAddressWherePersonCanBeFound.details) }}
                            </span>
                        </dd>
                        <dd class="govuk-summary-list__actions">
                            <a class='govuk-link' href='xyz'>Edit</a>
                        </dd>
                    </div>
                </dl>


                <h2 class='govuk-heading-m'>Probation details from the Part A</h2>

                <dl class="govuk-summary-list govuk-!-margin-bottom-4">
                    <div class="govuk-summary-list__row">
                        <dt class="govuk-summary-list__key">
                        </dt>
                    </div>
                    <div class="govuk-summary-list__row">
                        <dt class="govuk-summary-list__key">
                            Recall received date
                        </dt>
                        <dd class="govuk-summary-list__value">
                            {{ formatDateTimeFromIsoString({ isoDate: recallReceived, dateOnly: true }) }}
                        </dd>
                        <dd class="govuk-summary-list__actions">
                            <a class='govuk-link' href='edit-recall-received-date-and-time'>Edit</a>
                        </dd>
                    </div>
                    <div class="govuk-summary-list__row">
                        <dt class="govuk-summary-list__key">
                            Recall received time
                        </dt>
                        <dd class="govuk-summary-list__value">
                            {{ formatDateTimeFromIsoString({ isoDate: recallReceived, timeOnly: true }) }}
                        </dd>
                        <dd class="govuk-summary-list__actions">
                            <a class='govuk-link' href='edit-recall-received-date-and-time'>Edit</a>
                        </dd>
                    </div>
                    <div class="govuk-summary-list__row">
                        <dt class="govuk-summary-list__key">
                            Recall decision date
                        </dt>
                        <dd class="govuk-summary-list__value">
                            {{ formatDateTimeFromIsoString({ isoDate: poRecallConsultSpo.created, dateOnly: true }) }}
                        </dd>
                    </div>
                    <div class="govuk-summary-list__row">
                        <dt class="govuk-summary-list__key">
                            Recall decision time
                        </dt>
                        <dd class="govuk-summary-list__value">
                            {{ formatDateTimeFromIsoString({ isoDate: poRecallConsultSpo.created, timeOnly: true }) }}
                        </dd>
                    </div>
                    <div class="govuk-summary-list__row">
                        <dt class="govuk-summary-list__key">
                            {{ errorDisplay(errors.probationArea) }}
                            Probation area
                        </dt>
                        <dd class="govuk-summary-list__value">
                            {{ blankSafe(recommendation.bookRecallToPpud.probationArea, true, 'You must enter probation area') }}
                        </dd>
                        <dd class="govuk-summary-list__actions">
                            <a class='govuk-link' href='edit-probation-area'>Edit</a>
                        </dd>
                    </div>
                    <div class="govuk-summary-list__row">
                        <dt class="govuk-summary-list__key">
                            Probation practitioner
                        </dt>
                        <dd class="govuk-summary-list__value">
                            {{ blankSafe(practitioner.name) }}
                        </dd>
                    </div>
                    <div class="govuk-summary-list__row">
                        <dt class="govuk-summary-list__key">
                            Probation practitioner email
                        </dt>
                        <dd class="govuk-summary-list__value">
                            {{ blankSafe(practitioner.email) }}
                        </dd>
                    </div>
                    <div class="govuk-summary-list__row">
                        <dt class="govuk-summary-list__key">
                            Probation practitioner phone number
                        </dt>
                        <dd class="govuk-summary-list__value">
                            {{ blankSafe(practitioner.telephone) }}
                        </dd>
                    </div>
                    <div class="govuk-summary-list__row">
                        <dt class="govuk-summary-list__key">
                            {{ errorDisplay(errors.policeForce) }}
                            Local police contact
                        </dt>
                        <dd class="govuk-summary-list__value">
                            {{ blankSafe(recommendation.bookRecallToPpud.policeForce, true, 'You must enter local police force') }}
                        </dd>
                        <dd class="govuk-summary-list__actions">
                            <a class='govuk-link' href='edit-police-contact'>Edit</a>
                        </dd>
                    </div>
                    <div class="govuk-summary-list__row">
                        <dt class="govuk-summary-list__key">
                            Senior manager (ACO)
                        </dt>
                        <dd class="govuk-summary-list__value">
                            {{ acoSigned.createdByUserFullName }}
                        </dd>
                    </div>
                    <div class="govuk-summary-list__row">
                        <dt class="govuk-summary-list__key">
                            Senior manager (ACO) email
                        </dt>
                        <dd class="govuk-summary-list__value">
                            {{ acoSigned.emailAddress }}
                        </dd>
                    </div>
                    <div class="govuk-summary-list__row">
                        <dt class="govuk-summary-list__key">
                            {{ errorDisplay(errors.mappaLevel) }}
                            MAPPA level
                        </dt>
                        <dd class="govuk-summary-list__value">
                            {{ blankSafe(recommendation.bookRecallToPpud.mappaLevel, true, 'You must enter MAPPA level') }}
                        </dd>
                        <dd class="govuk-summary-list__actions">
                            <a class='govuk-link' href='edit-mappa-level'>Edit</a>
                        </dd>
                    </div>
                    <div class="govuk-summary-list__row">
                        <dt class="govuk-summary-list__key">
                            Current risk of serious harm
                        </dt>
                        <dd class="govuk-summary-list__value">
                            {{ getRiskLevelText(currentHighestRosh) }}
                        </dd>
                    </div>
                </dl>
                {{ formSubmitButton({ label: 'Accept and continue' }) }}
            </form>
        </div>
    </div>
{% endblock %}