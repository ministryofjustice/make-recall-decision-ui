<h1 class='govuk-heading-m govuk-visually-hidden'>Contact history<span class='govuk-visually-hidden'> for {{ caseSummary.personalDetailsOverview.name }}</span></h1>
<div class="govuk-grid-row">
    {% include './contactFilters.njk' %}
    <div class="govuk-grid-column-two-thirds-from-desktop">
        {% set innerLoopIndex = 0 %}
        <h2 class='govuk-body govuk-!-margin-bottom-4 govuk-!-font-weight-bold'>
            {{ countLabel({ count: caseSummary.contactCount, noun: 'contact'}) }}
        </h2>
        <div class="filter-toggle"></div>
        {% for group in caseSummary.contactSummary.items %}
            <h3 class='govuk-body govuk-!-margin-top-6 govuk-!-margin-bottom-2' data-qa='date-{{ loop.index0 }}'>
                {{ formatDateTimeFromIsoString({ isoDate: group.groupValue, dateOnly: true}) }}
            </h3>
            {% for contact in group.items %}
                {% set titleHtml %}
                    <div>
                        <div class='govuk-!-font-weight-bold' data-qa='heading'>{{ contact.descriptionType }}{% if contact.sensitive %}<span data-qa='sensitive'> (sensitive)</span>{% endif %} </div>
                        <div class='govuk-!-margin-bottom-0' data-qa='time'>
                            At {{ formatDateTimeFromIsoString({ isoDate: contact.contactStartDate, timeOnly: true }) }}</div>
                    </div>
                {% endset %}
                {% set actionsHtml %}
                    {% if contact.outcome or contact.enforcementAction %}
                        <div>
                            {% if contact.outcome %}
                                <div class='govuk-!-margin-bottom-1'>
                                    {{ mojBadge({
                                        text: contact.outcome,
                                        attributes: {
                                            'data-qa': 'outcome'
                                        }
                                    })}}
                                </div>
                            {% endif %}
                            {{ mojBadge({
                                text: contact.enforcementAction,
                                attributes: {
                                    'data-qa': 'enforcementAction'
                                }
                            }) if contact.enforcementAction else undefined }}
                        </div>
                    {% endif %}
                {% endset %}
                {% set notesHtml %}
                    <pre class='govuk-body' data-qa='notes'>{{ contact.notes }}</pre>
                {% endset %}
                {% set sectionHtml %}
                    {{ govukDetails({
                        summaryText: "View more detail",
                        html: notesHtml,
                        open: contact.searchTextMatch.notesMatched
                    }) }}
                {% endset %}
                <div data-qa='contact-{{ innerLoopIndex }}'>
                    {{ appSummaryCard({
                        titleHtml: titleHtml,
                        headingLevel: 4,
                        classes: 'govuk-!-margin-bottom-3',
                        html: sectionHtml if contact.notes else undefined,
                        actionsHtml: actionsHtml
                    }) }}
                </div>
                {% set innerLoopIndex = innerLoopIndex + 1 %}
            {% endfor %}
        {% endfor %}
    </div>
</div>

<script nonce='{{ cspNonce }}'>
  new MOJFrontend.FilterToggleButton({
    bigModeMediaQuery: "(min-width: 48.063em)",
    startHidden: false,
    toggleButton: {
      container: $(".filter-toggle"),
      showText: "Show filter",
      hideText: "Hide filter",
      classes: "govuk-button--secondary",
    },
    closeButton: {
      container: $(".moj-filter__header-action"),
      text: "Close",
    },
    filter: {
      container: $(".moj-filter"),
    },
  });
</script>