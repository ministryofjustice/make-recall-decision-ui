{% from "components/predictor-scale/macro.njk" import predictorScale %}

<h1 class='govuk-heading-m govuk-visually-hidden'>Risk<span
            class='govuk-visually-hidden'> for {{ caseSummary.personalDetailsOverview.name }}</span></h1>
<div class="flex flex--col-reverse-mobile">
    <div class="flex__item-two-thirds-desktop govuk-!-padding-right-4">
        {{ mojBanner({
               type: 'information',
               html: '<span class="govuk-!-font-weight-bold">This information is from the latest complete OASys assessment</span></br>Check OASys for new information. There may be a more recent assessment thatâ€™s not completed.',
               iconFallbackText: 'information'
           })
        }}
        <h2 class="govuk-heading-m">ROSH Summary</h2>
        {% if caseSummary.assessmentStatus === 'INCOMPLETE' %}
            <div class='govuk-!-margin-bottom-6'>
                {% include './notificationBanners/latestCompleteAssessment.njk' %}
            </div>
        {% endif %}
        <div class='govuk-!-margin-bottom-8'>
        {{ oasysCard({
            cardHeading: 'Who is at risk',
            oasysHeading: 'OASys R10.1 Who is at risk?',
            error: caseSummary.roshSummary.error,
            notifications: notifications,
            content: { text: caseSummary.roshSummary.whoIsAtRisk },
            lastUpdated: caseSummary.roshSummary.lastUpdatedDate,
            attributes: {
                'data-analytics-event-category': caseSummary.roshSummary.lastUpdatedDate,
                'data-analytics-event-label': 'Who is at risk'
            },
            dataQaAttr: 'whoIsAtRisk'
        }) }}
        {{ oasysCard({
            cardHeading: 'Details of the risk',
            oasysHeading: 'OASys R10.2 What is the nature of the risk?',
            error: caseSummary.roshSummary.error,
            notifications: notifications,
            content: { text: caseSummary.roshSummary.natureOfRisk },
            lastUpdated: caseSummary.roshSummary.lastUpdatedDate,
            attributes: {
                'data-analytics-event-category': caseSummary.roshSummary.lastUpdatedDate,
                'data-analytics-event-label': 'Details of the risk'
            },
            dataQaAttr: 'natureOfRisk'
        }) }}
        {{ oasysCard({
            cardHeading: 'When the risk will be highest',
            oasysHeading: 'OASys R10.3 When is the risk likely to be greatest?',
            error: caseSummary.roshSummary.error,
            notifications: notifications,
            content: { text: caseSummary.roshSummary.riskImminence },
            lastUpdated: caseSummary.roshSummary.lastUpdatedDate,
            attributes: {
                'data-analytics-event-category': caseSummary.roshSummary.lastUpdatedDate,
                'data-analytics-event-label': 'When the risk will be highest'
            },
            dataQaAttr: 'riskImminence'
        }) }}
        {{ oasysCard({
            cardHeading: 'Circumstances that will increase the risk',
            oasysHeading: 'OASys R10.4 What circumstances are likely to increase the risk?',
            error: caseSummary.roshSummary.error,
            notifications: notifications,
            content: { text: caseSummary.roshSummary.riskIncreaseFactors },
            lastUpdated: caseSummary.roshSummary.lastUpdatedDate,
            attributes: {
                'data-analytics-event-category': caseSummary.roshSummary.lastUpdatedDate,
                'data-analytics-event-label': 'Circumstances that will increase the risk'
            },
            dataQaAttr: 'riskIncreaseFactors'
        }) }}
        {{ oasysCard({
            cardHeading: 'Factors that will reduce the risk',
            oasysHeading: 'OASys R10.5 What factors are likely to reduce the risk?',
            error: caseSummary.roshSummary.error,
            notifications: notifications,
            content: { text: caseSummary.roshSummary.riskMitigationFactors },
            lastUpdated: caseSummary.roshSummary.lastUpdatedDate,
            attributes: {
                'data-analytics-event-category': caseSummary.roshSummary.lastUpdatedDate,
                'data-analytics-event-label': 'Factors that will reduce the risk'
            },
            dataQaAttr: 'riskMitigationFactors'
        }) }}
        </div>
        <div class='govuk-!-margin-bottom-4 govuk-section-break--visible'>
        {% set hasV2 =
          caseSummary.predictorScales.allReoffending
          or caseSummary.predictorScales.violentReoffending
          or caseSummary.predictorScales.seriousViolentReoffending
          or caseSummary.predictorScales.directContactSexual
          or caseSummary.predictorScales.indirectImageContactSexual
          or caseSummary.predictorScales.combinedSerious
        %}
        {% if hasV2 %}
             <!-- V2 scores-->
            {% if caseSummary.predictorScales and caseSummary.predictorScales.allReoffending %}
              {{ predictorScale({
                  predictorScore: caseSummary.predictorScales.allReoffending,
                  includeScore: true,
                  includeVeryHigh: true,
                  includePercentage: true
              }) }}
            {% else %}
              <h2 class="govuk-heading-m score-header govuk-!-margin-bottom-0">
                 All Reoffending Predictor (2 years)
              </h2>
              <p class='govuk-body' data-qa='allReoffending-missing'>Data not available.</p>
            {% endif %}

            {% if caseSummary.predictorScales and caseSummary.predictorScales.violentReoffending %}
              {{ predictorScale({
                  predictorScore: caseSummary.predictorScales.violentReoffending,
                  includeScore: true,
                  includeVeryHigh: true,
                  includePercentage: true
              }) }}
            {% else %}
               <h2 class="govuk-heading-m score-header govuk-!-margin-bottom-0">
                  Violent Reoffending Predictor (2 years)
               </h2>
               <p class='govuk-body' data-qa='violentReoffending-missing'>Data not available.</p>
            {% endif %}

            {% if caseSummary.predictorScales and caseSummary.predictorScales.directContactSexual %}
              {{ predictorScale({
                  predictorScore: caseSummary.predictorScales.directContactSexual,
                  includeScore: false,
                  includeVeryHigh: true,
                  includePercentage: true
              }) }}
            {% else %}
               <h2 class="govuk-heading-m score-header govuk-!-margin-bottom-0">
                 Direct Contact - Sexual Reoffending Predictor
               </h2>
               <p class='govuk-body' data-qa='directContactSexual-missing'>Data not available.</p>
            {% endif %}

            {% if caseSummary.predictorScales and caseSummary.predictorScales.indirectImageContactSexual %}
              {{ predictorScale({
                  predictorScore: caseSummary.predictorScales.indirectImageContactSexual,
                  includeScore: false,
                  includeVeryHigh: false,
                  includePercentage: true
              }) }}
            {% else %}
               <h2 class="govuk-heading-m score-header govuk-!-margin-bottom-0">
                 Images and Indirect Contact - Sexual Reoffending Predictor
               </h2>
               <p class='govuk-body' data-qa='indirectImageContactSexual-missing'>Data not available.</p>
            {% endif %}

            {% if caseSummary.predictorScales and caseSummary.predictorScales.seriousViolentReoffending %}
              {{ predictorScale({
                  predictorScore: caseSummary.predictorScales.seriousViolentReoffending,
                  includeScore: false,
                  includeVeryHigh: true,
                  includePercentage: false
              }) }}
            {% else %}
               <h2 class="govuk-heading-m score-header govuk-!-margin-bottom-0">
                 Serious Violent Reoffending Predictor (2 years)
               </h2>
               <p class='govuk-body' data-qa='seriousViolentReoffending-missing'>Data not available.</p>
            {% endif %}

           {% if caseSummary.predictorScales and caseSummary.predictorScales.combinedSerious %}
              {{ predictorScale({
                  predictorScore: caseSummary.predictorScales.combinedSerious,
                  includeScore: true,
                  includeVeryHigh: true,
                  includePercentage: true
              }) }}
            {% else %}
               <h2 class="govuk-heading-m score-header govuk-!-margin-bottom-0">
                 Combined Serious Reoffending Predictor
               </h2>
               <p class='govuk-body' data-qa='combinedSerious-missing'>Data not available.</p>
            {% endif %}
        {% else %}
            <!-- V1 scores-->
            {% if caseSummary.predictorScales and caseSummary.predictorScales.ogrs %}
              {{ predictorScale({
                  predictorScore: caseSummary.predictorScales.ogrs,
                  includeScore: true,
                  includeVeryHigh: true,
                  includePercentage: true
              }) }}
            {% else %}
               <h2 class="govuk-heading-m score-header govuk-!-margin-bottom-0">
                 OGRS3
               </h2>
               <p class='govuk-body' data-qa='ogrs-missing'>Data not available.</p>
            {% endif %}

            {% if caseSummary.predictorScales and caseSummary.predictorScales.rsr %}
              {{ predictorScale({
                  predictorScore: caseSummary.predictorScales.rsr,
                  includeScore: true,
                  includeVeryHigh: true,
                  includePercentage: true
              }) }}
            {% else %}
               <h2 class="govuk-heading-m score-header govuk-!-margin-bottom-0">
                RSR
               </h2>
               <p class='govuk-body' data-qa='rsr-missing'>Data not available.</p>
            {% endif %}

            {% if caseSummary.predictorScales and caseSummary.predictorScales.ogp %}
              {{ predictorScale({
                  predictorScore: caseSummary.predictorScales.ogp,
                  includeScore: true,
                  includeVeryHigh: true,
                  includePercentage: true
              }) }}
            {% else %}
               <h2 class="govuk-heading-m score-header govuk-!-margin-bottom-0">
                 OGP
               </h2>
               <p class='govuk-body' data-qa='ogp-missing'>Data not available.</p>
            {% endif %}

            {% if caseSummary.predictorScales and caseSummary.predictorScales.ovp %}
              {{ predictorScale({
                  predictorScore: caseSummary.predictorScales.ovp,
                  includeScore: true,
                  includeVeryHigh: true,
                  includePercentage: true
              }) }}
            {% else %}
               <h2 class="govuk-heading-m score-header govuk-!-margin-bottom-0">
                OVP
               </h2>
               <p class='govuk-body' data-qa='ovp-missing'>Data not available.</p>
            {% endif %}



           {% set hasOldPair = (caseSummary.predictorScales.ospc) or (caseSummary.predictorScales.ospi) %}
           {% set hasNewPair = (caseSummary.predictorScales.ospdc) or (caseSummary.predictorScales.ospiic) %}



            {% if hasNewPair or not hasOldPair %}
              {% if caseSummary.predictorScales.ospiic %}
                {{ predictorScale({
                    predictorScore: caseSummary.predictorScales.ospiic,
                    includeScore: true,
                    includeVeryHigh: false,
                    includePercentage: true
                }) }}
              {% else %}
                  <h2 class="govuk-heading-m score-header govuk-!-margin-bottom-0">
                     OSP/IIC
                  </h2>
                  <p class='govuk-body' data-qa='ospiic-missing'>Data not available.</p>
               {% endif %}

               {% if caseSummary.predictorScales.ospdc %}
                 {{ predictorScale({
                     predictorScore: caseSummary.predictorScales.ospdc,
                     includeScore: true,
                     includeVeryHigh: false,
                     includePercentage: true
                 }) }}
               {% else %}
                  <h2 class="govuk-heading-m score-header govuk-!-margin-bottom-0">
                    OSP/DC
                  </h2>
                  <p class='govuk-body' data-qa='ospdc-missing'>Data not available.</p>
               {% endif %}
            {% else %}
                {% if caseSummary.predictorScales and caseSummary.predictorScales.ospc %}
                  {{ predictorScale({
                      predictorScore: caseSummary.predictorScales.ospc,
                      includeScore: false,
                      includeVeryHigh: true,
                      includePercentage: true
                  }) }}
                {% else %}
                   <h2 class="govuk-heading-m score-header govuk-!-margin-bottom-0">
                    OSPC
                   </h2>
                   <p class='govuk-body' data-qa='ospc-missing'>Data not available.</p>
                {% endif %}

                {% if caseSummary.predictorScales and caseSummary.predictorScales.ospi %}
                  {{ predictorScale({
                      predictorScore: caseSummary.predictorScales.ospi,
                      includeScore: true,
                      includeVeryHigh: false,
                      includePercentage: true
                  }) }}
                {% else %}
                   <h2 class="govuk-heading-m score-header govuk-!-margin-bottom-0">
                   OSPI
                   </h2>
                   <p class='govuk-body' data-qa='ospi-missing'>Data not available.</p>
                {% endif %}
            {% endif %}
        {% endif %}
    </div>
    </div>
    <div class="flex__item-one-third-desktop">
        <div data-qa='roshTable'>
            {{ roshWidget({ riskOfSeriousHarm: caseSummary.roshSummary if caseSummary.roshSummary.error else caseSummary.roshSummary.riskOfSeriousHarm, notifications: notifications, lastUpdatedDate: formatDateTimeFromIsoString({ isoDate: caseSummary.roshSummary.lastUpdatedDate, dateOnly: true }) }) }}
        </div>
        <div class="govuk-!-margin-bottom-4 side-bar" data-qa='mappa'>
            {{ mappaWidget({ mappa: caseSummary.mappa, lastUpdatedDate: formatDateTimeFromIsoString({ isoDate: caseSummary.mappa.lastUpdatedDate, dateOnly: true }) }) }}
        </div>
        <div class="govuk-body predictor-timeline__heading">
            <h2 class="govuk-heading-m govuk-!-margin-bottom-2">Scores history</h2>
            {% if caseSummary.predictorScores.error and caseSummary.roshHistory.error %}
                <p class='govuk-body' data-qa='timeline-missing'>RoSH levels and predictor scores cannot be retrieved from NDelius or OASys. Double-check NDelius and OASys.</p>
            {% elseif caseSummary.predictorScores.error %}
                <p class='govuk-body' data-qa='score-history-missing'>Predictor scores cannot be retrieved from OASys. Double-check OASys.</p>
            {% elseif caseSummary.roshHistory.error %}
                <p class='govuk-body' data-qa='rosh-history-missing'>Historical RoSH levels cannot be retrieved from NDelius. Double-check NDelius and OASys.</p>
            {% endif %}
            {% if caseSummary.timeline.length %}
                <div>
                    <button type='button' data-js="predictor-timeline__toggle-all" class="reset-button link-button govuk-link">Open all<span class='govuk-visually-hidden'> scores in timeline</span> </button>
                </div>
            {% endif %}
        </div>
        {% if caseSummary.timeline.length %}
            {{ predictorTimeline(caseSummary.timeline, pageUrlBase) }}
        {% endif %}
    </div>
</div>