{% include '../partials/error-summary.njk' %}
<h1 class='govuk-heading-m'>Licence history</h1>
<div class="govuk-grid-row">
    {% if flags.dateFilters %}
    <div class="govuk-grid-column-one-third-from-desktop">
        {%- set filterOptionsHtml %}
            {{ govukDateInput({
                id: "dateFrom",
                namePrefix: "dateFrom",
                fieldset: {
                    legend: {
                        html: "Date range<span class='govuk-visually-hidden'> From</span>",
                        classes: "govuk-fieldset__legend--s"
                    }
                },
                items: dateTimeItems("dateFrom", caseSummary.filters.dateRange.dateFrom),
                errorMessage: errorMessage(errors.dateFrom)
            }) }}
            {{ govukDateInput({
                id: "dateTo",
                namePrefix: "dateTo",
                fieldset: {
                    legend: {
                        html: "<span class='govuk-visually-hidden'>Date range </span>To",
                        classes: "govuk-fieldset__legend--s"
                    }
                },
                items: dateTimeItems("dateTo", caseSummary.filters.dateRange.dateTo),
                errorMessage: errorMessage(errors.dateTo)
            }) }}
        {% endset -%}
        <form>
            <input type='hidden' name='dateFilters' value='1' />
            {{ mojFilter({
                heading: {
                    text: 'Filter'
                },
                selectedFilters: {
                    heading: {
                        text: 'Selected filters'
                    },
                    clearLink: {
                        text: 'Clear filters',
                        href: urlInfo.path + '?dateFilters=1'
                    },
                    categories: [{
                        heading: {
                            text: 'Date range'
                        },
                        items: [{
                            href: urlInfo.path + '?dateFilters=1',
                            text: caseSummary.filters.dateRange.selectedLabel
                        }]
                    }]
                } if caseSummary.filters.dateRange.selectedLabel else undefined,
                optionsHtml: filterOptionsHtml
            }) }}
        </form>
    </div>
    {% endif %}
    <div class="govuk-grid-column-two-thirds-from-desktop">
        {% set innerLoopIndex = 0 %}
        <div class='govuk-body govuk-!-margin-bottom-4 govuk-!-font-weight-bold'>{{ caseSummary.contactCount }}
            contacts
        </div>
        {% for group in caseSummary.contactSummary.items %}
            <div class='govuk-body govuk-!-margin-top-6 govuk-!-margin-bottom-2' data-qa='date-{{ loop.index0 }}'>
                {{ formatDateTimeFromIsoString({ isoDate: group.groupValue, dateOnly: true}) }}
            </div>
            {% for contact in group.items %}
                {% set titleHtml %}
                    <div>
                        <div class='govuk-!-font-weight-bold' data-qa='heading'>{{ contact.descriptionType }}</div>
                        <div class='govuk-!-margin-bottom-0' data-qa='time'>
                            At {{ formatDateTimeFromIsoString({ isoDate: contact.contactStartDate, timeOnly: true }) }}</div>
                    </div>
                {% endset %}
                {% set actionsHtml %}
                    {% if contact.outcome or contact.enforcementAction %}
                        <div>
                            {% if contact.outcome %}
                                <div class='govuk-!-margin-bottom-1'>
                                    {{ mojBadge({
                                        text: contact.outcome,
                                        attributes: {
                                            'data-qa': 'outcome'
                                        }
                                    })}}
                                </div>
                            {% endif %}
                            {{ mojBadge({
                                text: contact.enforcementAction,
                                attributes: {
                                    'data-qa': 'enforcementAction'
                                }
                            }) if contact.enforcementAction else undefined }}
                        </div>
                    {% endif %}
                {% endset %}
                {% set notesHtml %}
                    <pre class='govuk-body' data-qa='notes'>{{ contact.notes }}</pre>
                {% endset %}
                {% set sectionHtml %}
                    {% if flags.collapsibleNotes %}
                        {{ govukDetails({
                            summaryText: "View more detail",
                            html: notesHtml
                        }) }}
                    {% else %}
                        {{ notesHtml | safe }}
                    {% endif %}
                {% endset %}
                <div data-qa='contact-{{ innerLoopIndex }}'>
                    {{ appSummaryCard({
                        titleHtml: titleHtml,
                        classes: 'govuk-!-margin-bottom-3',
                        html: sectionHtml,
                        actionsHtml: actionsHtml
                    }) }}
                </div>
                {% set innerLoopIndex = innerLoopIndex + 1 %}
            {% endfor %}
        {% endfor %}
    </div>
</div>