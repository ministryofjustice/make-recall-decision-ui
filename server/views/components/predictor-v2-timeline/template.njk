{% from "components/predictor-timeline-item/macro.njk" import predictorTimelineItem %}

{% set ogrs4ReleaseDate = ogrs4ReleaseDate | default("23 February 2026 at 09:00") %}
{% set hasTimelineWarning = false %}

{% macro predictorV2TimelineItem(predictor, isLegacy) %}
  {% if predictor %}

    {% set timelineItemClass = '' %}

    {% if isLegacy %}

      {% switch predictor.level %}
          {% case 'VERY_HIGH' %}
            {% set timelineItemClass = 'legacy-predictor-timeline-item--very-high' %}
          {% case 'HIGH' %}
            {% set timelineItemClass = 'legacy-predictor-timeline-item--high' %}
          {% case 'MEDIUM' %}
            {% set timelineItemClass = 'legacy-predictor-timeline-item--medium' %}
          {% case 'LOW' %}
            {% set timelineItemClass = 'legacy-predictor-timeline-item--low' %}
          {% default %}
            {% set timelineItemClass = 'legacy-predictor-timeline-item--default' %}
      {% endswitch %}

      {% if predictor.level is undefined %}
          {% set band = 'UNKNOWN' %}
          {% set timelineItemClass = 'legacy-predictor-timeline-item--default' %}
      {% else %}
          {% set band = predictor.level | replace('_', ' ') %}
      {% endif %}

      <div class="{{ timelineItemClass }}">
        <span
          class="legacy-predictor-timeline-item__type_and_level">{{ predictor.type | upper }} <strong>{{ band }}</strong></span>

        {% if predictor.score and timelineItemClass != 'legacy-predictor-timeline-item--default' %}
          <span class="legacy-predictor-timeline-item__score">{{ predictor.score }}%</span>
        {% endif %}

        {% if predictor.staticOrDynamic and timelineItemClass != 'legacy-predictor-timeline-item--default' %}
          <span
            class="legacy-predictor-timeline-item__static_or_dynamic">{{ predictor.staticOrDynamic | capitalize }}</span>
        {% endif %}

      </div>

    {% else %}

      {% switch predictor.level %}
          {% case 'VERY_HIGH' %}
            {% set timelineItemClass = 'predictor-timeline-item--very-high' %}
          {% case 'HIGH' %}
            {% set timelineItemClass = 'predictor-timeline-item--high' %}
          {% case 'MEDIUM' %}
            {% set timelineItemClass = 'predictor-timeline-item--medium' %}
          {% case 'LOW' %}
            {% set timelineItemClass = 'predictor-timeline-item--low' %}
          {% default %}
            {% set timelineItemClass = 'predictor-timeline-item--default' %}
      {% endswitch %}

      {% if predictor.level is undefined %}
          {% set band = 'UNKNOWN' %}
          {% set timelineItemClass = 'predictor-timeline-item--default' %}
      {% else %}
          {% set band = predictor.level | replace('_', ' ') %}
      {% endif %}

      {% set staticOrDynamicClass = 'predictor-timeline-item__static_or_dynamic' %}
      {% if predictor.score and predictor.level in ['VERY_HIGH', 'MEDIUM'] and predictor.staticOrDynamic === 'DYNAMIC' %}
        {% set staticOrDynamicClass = staticOrDynamicClass + ' predictor-timeline-item__wrapped_static_or_dynamic' %}
      {% endif %}

      <div class="{{ timelineItemClass }}">
        <span class="predictor-timeline-item__type">{{ predictor.type | title }}</span>

        <div class="predictor-timeline-item__stats">
          <span class="predictor-timeline-item__level">{{ band }}</span>

          {% if predictor.score and timelineItemClass != 'predictor-timeline-item--default' %}
            <span class="predictor-timeline-item__score">{{ predictor.score }}%</span>
          {% endif %}

          {% if predictor.staticOrDynamic and timelineItemClass != 'predictor-timeline-item--default' %}
            <span class="{{ staticOrDynamicClass }}">{{ predictor.staticOrDynamic | capitalize }}</span>
          {% endif %}
        </div>
      </div>
    {% endif %}
  {% endif %}
{% endmacro %}

{% macro timelineWarning() %}
  <div class="predictor-timeline__item">
    <div class="predictor-timeline__header">
      <p class="predictor-timeline__byline">{{ ogrs4ReleaseDate }}</p>
    </div>
    <div class="predictor-timeline__description">
      <div class="govuk-warning-text predictor-timeline__warning">
        <span class="govuk-warning-text__icon" aria-hidden="true">!</span>
        <strong class="govuk-warning-text__text">
                <span
                  class="govuk-visually-hidden">Warning the risk predictor tools have been updated after this date</span>
          All assessments started after this date use updated risk predictor tools
        </strong>
      </div>
      <details class="govuk-details predictor-timeline__details">
        <summary class="govuk-details__summary">
              <span class="govuk-details__summary-text">
                How the risk predictor tools have changed
              </span>
        </summary>
        <div class="govuk-details__text">
          <h3>All reoffending</h3>
          <b>Old version:</b> Offender Group Reconviction Scale (OGRS)<br>
          <b>Updated version:</b> All Reoffending Predictor<br>
          <br>
          The All Reoffending Predictor now has both a static and dynamic version.
          <br><br>
          <h3>Violent reoffending</h3>
          <b>Old version:</b> OASys Violent Predictor (OVP)<br>
          <b>Updated version:</b> Violent Reoffending Predictor<br>
          <br>
          The Violent Reoffending Predictor now has both a static and dynamic version.
          <br><br>
          <h3>Sexual reoffending</h3>
          <h4>Direct contact</h4>
          <b>Old version:</b> OASys Sexual Predictor — Direct Contact (OSP-DC)<br>
          <b>Updated version:</b> Direct Contact — Sexual Reoffending Predictor<br>
          <br>
          The Direct Contact — Sexual Reoffending Predictor only has a static score.
          <br>
          <h4>Indirect contact</h4>
          <b>Old version:</b> OASys Sexual Predictor — Images and indirect contact with children (OSP-IIC)<br>
          <b>Updated version:</b> Images and Indirect Contact — Sexual Reoffending Predictor<br>
          <br>
          The Images and Indirect Contact — Sexual Reoffending Predictor only has a static score.
          <br><br>
          <h3>Serious non-sexual violent reoffending</h3>
          <b>Old version:</b> Previously part of RSR but not displayed<br>
          <b>Updated version:</b> Serious Violent Reoffending Predictor<br>
          <br>
          The Serious Violent Reoffending Predictor has both static and dynamic versions.
          <br><br>
          <h3>Serious reoffending</h3>
          This predictor is a combination of the Direct Contact — Sexual Reoffending Predictor, Images and
          Indirect Contact — Sexual Reoffending Predictor and Serious Violent Reoffending Predictor scores.
          <br>
          <b>Old version:</b> Risk of Serious Recidivism (RSR)<br>
          <b>Updated version:</b> Combined Serious Reoffending Predictor<br>
          <br>
          The Combined Serious Reoffending Predictor has both static and dynamic versions.
          <br><br>
          <h3>Which version will be displayed</h3>
          All tools only show a dynamic score if both versions are available.
          <br>
        </div>
      </details>
    </div>
  </div>
{% endmacro %}

<div class="predictor-timeline__heading">
  <span class='govuk-heading-m'>Scores history</span>
   <button id="predictor-timeline__toggle-all" class="predictor-timeline-link-btn" aria-label="Open all score history"
       aria-controls="{{ allSectionIds }}" aria-expanded="false">Open all</button>
</div>

<div class="predictor-timeline predictor">
  {% for item in predictorScores %}

    {# --- RoSH entries: always visible --- #}
    {% if item.type == 'RoSH' %}
      <div class="predictor-timeline__item" data-qa='timeline-item-{{ loop.index }}'>
        <div class="predictor-timeline__header">
          <p class="predictor-timeline__byline">{{ item.formattedDate }}</p>
        </div>

        <div class="predictor-timeline__description">
          <div class='flex flex--align-center govuk-!-margin-bottom-2'>
            {{ predictorTimelineItem({ type: item.type, level: item.level }) }}
            <span class='govuk-!-padding-left-2 govuk-!-font-size-16'>from NDelius</span>
          </div>

          <div class='govuk-!-font-size-16'>
               <a href='{{ pageUrlBase }}contact-history?{{ formatDateFilterQueryString(item.date) }}&includeSystemGenerated=YES' data-qa='view-contacts'>View contacts<span class='govuk-visually-hidden'> from {{ formatDateTimeFromIsoString({ isoDate: item.date, dateOnly: true }) }}</span></a><span aria-hidden='true'> from this day</span>
          </div>

          {% if item.notes %}
            <details class="govuk-details govuk-!-margin-top-2 govuk-!-margin-bottom-0">
              <summary class="govuk-details__summary">
                <span class="govuk-details__summary-text govuk-!-font-size-16">
                  View notes
                  <span class="govuk-visually-hidden">
                    on RoSH history on {{ formatDateTimeFromIsoString({ isoDate: item.date, dateOnly: true }) }}
                  </span>
                </span>
              </summary>
              <div class="govuk-details__text">
                <pre class='govuk-body govuk-!-font-size-16'>{{ item.notes }}</pre>
              </div>
            </details>
          {% endif %}
        </div>
      </div>

    {% else %}
      {# --- V1/V2 predictors: collapsible --- #}
      {% if hasTimelineWarning === false %}
        {% if item.date | isBefore(ogrs4ReleaseDate) %}
          {{ timelineWarning() }}
          {% set hasTimelineWarning = true %}
        {% endif %}
      {% endif %}

      <div class="predictor-timeline__item" data-qa='timeline-item-{{ loop.index }}'>
        <div class="predictor-timeline__header">
          <p class="predictor-timeline__byline">{{ item.formattedDate }}</p>
        </div>

        <div class="predictor-timeline__description predictor-timeline-section predictor-timeline-section--hidden">
          <div class="predictor-timeline-section-content">
            <ul class="govuk-list">
              {% for key, value in item.scores %}
                {% if key | upper not in ['OGRS', 'OGP', 'OVP', 'RSR', 'OSPDC', 'OSPC', 'OSPIIC', 'OSPI'] %}
                  <li>{{ predictorV2TimelineItem(value, false) }}</li>
                {% else %}
                  <li>{{ predictorV2TimelineItem(value, true) }}</li>
                {% endif %}
              {% endfor %}
            </ul>
          </div>
        </div>

        <button class="predictor-timeline-link-btn predictor-timeline__toggle-section" aria-label="View scores for {{ item.date }}"
                  aria-controls="{{ sectionId }}" aria-expanded="false">Open</button>
      </div>

    {% endif %}

  {% endfor %}

  {% if hasTimelineWarning === false %}
    {{ timelineWarning() }}
  {% endif %}
</div>

<script src="/assets/js/predictor-timeline.js" defer></script>
